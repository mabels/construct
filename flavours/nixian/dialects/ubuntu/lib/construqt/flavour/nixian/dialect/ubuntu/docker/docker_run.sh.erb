#!/bin/sh
basedir=/var/lib/docker/construqt/<%= docker.name %>
if [ -d $basedir ]
then
  echo "Basedir: $basedir"
  cd $basedir
fi
<% docker.interfaces.values.select{|i| i.name != "lo" }.each do |iface| -%>
/bin/sh /etc/network/<%= iface.cable.connections.first.iface.name %>-docker-up.sh
<% end -%>
docker_name=run_<%= docker.name %>
docker_tag=$(hostname)-$(date +%Y%m%d%H%M%S)

for tag in $(docker images -a $docker_name --format '{{.Tag}}' | sort -n -r | tail -n +3)
do
	docker rmi $docker_name:$tag
done

docker build -t $docker_name:$docker_tag .
docker rm $docker_name
exec docker run --name $docker_name \
<% if docker.docker_deploy.get_privileged -%>
  --privileged \
<% end -%>
<% docker.interfaces.values.select{|i| i.name != "lo" }.each do |iface| -%>
  --net <%= iface.cable.connections.first.iface.name %> \
  <% iface.address.ips.each do |ip| -%>
    <% if ip.ipv4? -%>
    --ip=<%= ip.to_s %> \
    <% else -%>
    --ip6=<%= ip.to_s %> \
    <% end -%>
  <% end -%>
<% end -%>
<% docker.docker_deploy.get_maps.each do |h, d| -%>
  -v <%= h %>:<%= d %> \
<% end -%>
  -t $docker_name:$docker_tag
